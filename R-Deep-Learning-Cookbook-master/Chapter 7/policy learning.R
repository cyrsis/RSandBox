##############################   REINFORCEMENT LEARNING : POLICY LEARNING  ##############
## Load the library
library(MDPtoolbox)

## Define Action based transtion probabilities
up <- matrix(c(1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
               0.7	,	0.2	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
               0	,	0	,	0.8	,	0.05	,	0	,	0	,	0.15	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
               0	,	0	,	0.7	,	0.3	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
               0.1	,	0	,	0	,	0	,	0.7	,	0.1	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
               0	,	0.05	,	0	,	0	,	0.7	,	0.15	,	0.1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
               0	,	0	,	0.05	,	0	,	0	,	0.7	,	0.15	,	0.05	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0.7	,	0.2	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0	,
               0	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0.85	,	0.05	,	0	,	0	,	0.05	,	0	,	0	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.7	,	0.2	,	0.05	,	0	,	0	,	0.05	,	0	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0.7	,	0.2	,	0	,	0	,	0	,	0.05	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0.9	,	0	,	0	,	0	,	0.05	,
               0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0.9	,	0	,	0	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0.7	,	0.2	,	0	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0.8	,	0.15	,	0	,
               0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0.2	),
             nrow=16, ncol=16, byrow=TRUE)
left <- matrix(c(1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0.05	,	0.9	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0.9	,	0.05	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0.05	,	0.9	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0.8	,	0	,	0	,	0	,	0.1	,	0.05	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0.8	,	0	,	0	,	0.05	,	0.1	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0.8	,	0	,	0	,	0.05	,	0.1	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0.8	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0	,	0.1	,	0.05	,	0	,	0	,	0.05	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0.05	,	0.1	,	0.05	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0.1	,	0.1	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0	,	0.2	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0	,	0.2	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0.05	,	0.1	,	0.05	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0.05	,	0.1	,	0.05	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0.05	,	0.15),
               nrow=16, ncol=16, byrow=TRUE)
down <- matrix(c(0.1	,	0.8	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0.05	,	0.9	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0.1	,	0.8	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0.1	,	0.9	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0.05	,	0	,	0	,	0	,	0.15	,	0.8	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0.2	,	0.8	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0.2	,	0.8	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0.9	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0.1	,	0.8	,	0	,	0	,	0.05	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.2	,	0.8	,	0	,	0	,	0	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.05	,	0.8	,	0	,	0	,	0	,	0.05	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.05	,	0	,	0	,	0	,	0.9	,	0	,	0	,	0	,	0.05	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.2	,	0.8	,	0	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.05	,	0.15	,	0.8	,	0	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.2	,	0.8	,
                 0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	1),
               nrow=16, ncol=16, byrow=TRUE)
right <- matrix(c(0.2	,	0.1	,	0	,	0	,	0.7	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                  0.1	,	0.1	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0.2	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0.1	,	0.9	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0.2	,	0.1	,	0	,	0	,	0.7	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0.9	,	0.1	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0.05	,	0.1	,	0	,	0	,	0	,	0.85	,	0	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0.2	,	0	,	0	,	0	,	0.7	,	0	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.2	,	0	,	0	,	0	,	0.8	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0.9	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.1	,	0	,	0	,	0	,	0.9	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0.2	,	0	,	0	,	0	,	0.8	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	1	,	0	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	1	,	0	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	1	,	0	,
                  0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	0	,	1),
                nrow=16, ncol=16, byrow=TRUE)

## Make a list of all actions
TPMs <- list(up=up, left=left,
          down=down, right=right)

## Set up a reward matrix
Rewards <- matrix(c(-1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1, 
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              -1, -1, -1, -1,
              100, 100, 100, 100,
              -1, -1, -1, -1),
            nrow=16, ncol=4, byrow=TRUE)

## Check for MDP compliance
mdp_check(TPMs, Rewards) 

## Run the MDP policy iteration
mdp_policy <- mdp_policy_iteration(P=TPMs, R=Rewards, discount=0.9)
mdp_policy$policy
names(TPMs)[mdp_policy$policy]

## Values functions of the optimum policy
mdp_policy$V
names(mdp_policy$V) <- paste0("S",1:16)
barplot(mdp_policy$V,col="blue",xlab="states",ylab="Optimal value",main="Value function of the optimal Policy",width=0.5)
